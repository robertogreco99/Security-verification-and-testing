<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>fmtcheck.c</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">// This is a personal academic project. Dear PVS-Studio, please check it.</a>
<a name="ln2">// PVS-Studio Static Code Analyzer for C, C++, C#, and Java: http://www.viva64.com</a>
<a name="ln3">/*	$NetBSD: fmtcheck.c,v 1.8 2008/04/28 20:22:59 martin Exp $	*/</a>
<a name="ln4"> </a>
<a name="ln5">/*-</a>
<a name="ln6"> * Copyright (c) 2000 The NetBSD Foundation, Inc.</a>
<a name="ln7"> * All rights reserved.</a>
<a name="ln8"> *</a>
<a name="ln9"> * This code was contributed to The NetBSD Foundation by Allen Briggs.</a>
<a name="ln10"> *</a>
<a name="ln11"> * Redistribution and use in source and binary forms, with or without</a>
<a name="ln12"> * modification, are permitted provided that the following conditions</a>
<a name="ln13"> * are met:</a>
<a name="ln14"> * 1. Redistributions of source code must retain the above copyright</a>
<a name="ln15"> *    notice, this list of conditions and the following disclaimer.</a>
<a name="ln16"> * 2. Redistributions in binary form must reproduce the above copyright</a>
<a name="ln17"> *    notice, this list of conditions and the following disclaimer in the</a>
<a name="ln18"> *    documentation and/or other materials provided with the distribution.</a>
<a name="ln19"> *</a>
<a name="ln20"> * THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS</a>
<a name="ln21"> * ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED</a>
<a name="ln22"> * TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR</a>
<a name="ln23"> * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS</a>
<a name="ln24"> * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</a>
<a name="ln25"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</a>
<a name="ln26"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</a>
<a name="ln27"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</a>
<a name="ln28"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</a>
<a name="ln29"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</a>
<a name="ln30"> * POSSIBILITY OF SUCH DAMAGE.</a>
<a name="ln31"> */</a>
<a name="ln32"> </a>
<a name="ln33">#include &quot;file.h&quot;</a>
<a name="ln34"> </a>
<a name="ln35">#include &lt;stdio.h&gt;</a>
<a name="ln36">#include &lt;string.h&gt;</a>
<a name="ln37">#include &lt;ctype.h&gt;</a>
<a name="ln38"> </a>
<a name="ln39">enum __e_fmtcheck_types {</a>
<a name="ln40">	FMTCHECK_START,</a>
<a name="ln41">	FMTCHECK_SHORT,</a>
<a name="ln42">	FMTCHECK_INT,</a>
<a name="ln43">	FMTCHECK_LONG,</a>
<a name="ln44">	FMTCHECK_QUAD,</a>
<a name="ln45">	FMTCHECK_SHORTPOINTER,</a>
<a name="ln46">	FMTCHECK_INTPOINTER,</a>
<a name="ln47">	FMTCHECK_LONGPOINTER,</a>
<a name="ln48">	FMTCHECK_QUADPOINTER,</a>
<a name="ln49">	FMTCHECK_DOUBLE,</a>
<a name="ln50">	FMTCHECK_LONGDOUBLE,</a>
<a name="ln51">	FMTCHECK_STRING,</a>
<a name="ln52">	FMTCHECK_WIDTH,</a>
<a name="ln53">	FMTCHECK_PRECISION,</a>
<a name="ln54">	FMTCHECK_DONE,</a>
<a name="ln55">	FMTCHECK_UNKNOWN</a>
<a name="ln56">};</a>
<a name="ln57">typedef enum __e_fmtcheck_types EFT;</a>
<a name="ln58"> </a>
<a name="ln59">#define RETURN(pf,f,r) do { \</a>
<a name="ln60">			*(pf) = (f); \</a>
<a name="ln61">			return r; \</a>
<a name="ln62">		       } /*NOTREACHED*/ /*CONSTCOND*/ while (0)</a>
<a name="ln63"> </a>
<a name="ln64">static EFT</a>
<a name="ln65">get_next_format_from_precision(const char **pf)</a>
<a name="ln66">{</a>
<a name="ln67">	int		sh, lg, quad, longdouble;</a>
<a name="ln68">	const char	*f;</a>
<a name="ln69"> </a>
<a name="ln70">	sh = lg = quad = longdouble = 0;</a>
<a name="ln71"> </a>
<a name="ln72">	f = *pf;</a>
<a name="ln73">	switch (*f) {</a>
<a name="ln74">	case 'h':</a>
<a name="ln75">		f++;</a>
<a name="ln76">		sh = 1;</a>
<a name="ln77">		break;</a>
<a name="ln78">	case 'l':</a>
<a name="ln79">		f++;</a>
<a name="ln80">		if (!*f) RETURN(pf,f,FMTCHECK_UNKNOWN);</a>
<a name="ln81">		if (*f == 'l') {</a>
<a name="ln82">			f++;</a>
<a name="ln83">			quad = 1;</a>
<a name="ln84">		} else {</a>
<a name="ln85">			lg = 1;</a>
<a name="ln86">		}</a>
<a name="ln87">		break;</a>
<a name="ln88">	case 'q':</a>
<a name="ln89">		f++;</a>
<a name="ln90">		quad = 1;</a>
<a name="ln91">		break;</a>
<a name="ln92">	case 'L':</a>
<a name="ln93">		f++;</a>
<a name="ln94">		longdouble = 1;</a>
<a name="ln95">		break;</a>
<a name="ln96">#ifdef WIN32</a>
<a name="ln97">	case 'I':</a>
<a name="ln98">		f++;</a>
<a name="ln99">		if (!*f) RETURN(pf,f,FMTCHECK_UNKNOWN);</a>
<a name="ln100">		if (*f == '3' &amp;&amp; f[1] == '2') {</a>
<a name="ln101">			f += 2;</a>
<a name="ln102">		} else if (*f == '6' &amp;&amp; f[1] == '4') {</a>
<a name="ln103">			f += 2;</a>
<a name="ln104">			quad = 1;</a>
<a name="ln105">		}</a>
<a name="ln106">#ifdef _WIN64</a>
<a name="ln107">		else {</a>
<a name="ln108">			quad = 1;</a>
<a name="ln109">		}</a>
<a name="ln110">#endif</a>
<a name="ln111">		break;</a>
<a name="ln112">#endif</a>
<a name="ln113">	default:</a>
<a name="ln114">		break;</a>
<a name="ln115">	}</a>
<a name="ln116">	if (!*f) RETURN(pf,f,FMTCHECK_UNKNOWN);</a>
<a name="ln117">	if (strchr(&quot;diouxX&quot;, *f)) {</a>
<a name="ln118">		if (longdouble)</a>
<a name="ln119">			RETURN(pf,f,FMTCHECK_UNKNOWN);</a>
<a name="ln120">		if (lg)</a>
<a name="ln121">			RETURN(pf,f,FMTCHECK_LONG);</a>
<a name="ln122">		if (quad)</a>
<a name="ln123">			RETURN(pf,f,FMTCHECK_QUAD);</a>
<a name="ln124">		RETURN(pf,f,FMTCHECK_INT);</a>
<a name="ln125">	}</a>
<a name="ln126">	if (*f == 'n') {</a>
<a name="ln127">		if (longdouble)</a>
<a name="ln128">			RETURN(pf,f,FMTCHECK_UNKNOWN);</a>
<a name="ln129">		if (sh)</a>
<a name="ln130">			RETURN(pf,f,FMTCHECK_SHORTPOINTER);</a>
<a name="ln131">		if (lg)</a>
<a name="ln132">			RETURN(pf,f,FMTCHECK_LONGPOINTER);</a>
<a name="ln133">		if (quad)</a>
<a name="ln134">			RETURN(pf,f,FMTCHECK_QUADPOINTER);</a>
<a name="ln135">		RETURN(pf,f,FMTCHECK_INTPOINTER);</a>
<a name="ln136">	}</a>
<a name="ln137">	if (strchr(&quot;DOU&quot;, *f)) {</a>
<a name="ln138">		if (sh + lg + quad + longdouble)</a>
<a name="ln139">			RETURN(pf,f,FMTCHECK_UNKNOWN);</a>
<a name="ln140">		RETURN(pf,f,FMTCHECK_LONG);</a>
<a name="ln141">	}</a>
<a name="ln142">	if (strchr(&quot;eEfg&quot;, *f)) {</a>
<a name="ln143">		if (longdouble)</a>
<a name="ln144">			RETURN(pf,f,FMTCHECK_LONGDOUBLE);</a>
<a name="ln145">		if (sh + lg + quad)</a>
<a name="ln146">			RETURN(pf,f,FMTCHECK_UNKNOWN);</a>
<a name="ln147">		RETURN(pf,f,FMTCHECK_DOUBLE);</a>
<a name="ln148">	}</a>
<a name="ln149">	if (*f == 'c') {</a>
<a name="ln150">		if (sh + lg + quad + longdouble)</a>
<a name="ln151">			RETURN(pf,f,FMTCHECK_UNKNOWN);</a>
<a name="ln152">		RETURN(pf,f,FMTCHECK_INT);</a>
<a name="ln153">	}</a>
<a name="ln154">	if (*f == 's') {</a>
<a name="ln155">		if (sh + lg + quad + longdouble)</a>
<a name="ln156">			RETURN(pf,f,FMTCHECK_UNKNOWN);</a>
<a name="ln157">		RETURN(pf,f,FMTCHECK_STRING);</a>
<a name="ln158">	}</a>
<a name="ln159">	if (*f == 'p') {</a>
<a name="ln160">		if (sh + lg + quad + longdouble)</a>
<a name="ln161">			RETURN(pf,f,FMTCHECK_UNKNOWN);</a>
<a name="ln162">		RETURN(pf,f,FMTCHECK_LONG);</a>
<a name="ln163">	}</a>
<a name="ln164">	RETURN(pf,f,FMTCHECK_UNKNOWN);</a>
<a name="ln165">	/*NOTREACHED*/</a>
<a name="ln166">}</a>
<a name="ln167"> </a>
<a name="ln168">static EFT</a>
<a name="ln169">get_next_format_from_width(const char **pf)</a>
<a name="ln170">{</a>
<a name="ln171">	const char	*f;</a>
<a name="ln172"> </a>
<a name="ln173">	f = *pf;</a>
<a name="ln174">	if (*f == '.') {</a>
<a name="ln175">		f++;</a>
<a name="ln176">		if (*f == '*') {</a>
<a name="ln177">			RETURN(pf,f,FMTCHECK_PRECISION);</a>
<a name="ln178">		}</a>
<a name="ln179">		/* eat any precision (empty is allowed) */</a>
<a name="ln180">		while (isdigit((unsigned char)*f)) f++;</a>
<a name="ln181">		if (!*f) RETURN(pf,f,FMTCHECK_UNKNOWN);</a>
<a name="ln182">	}</a>
<a name="ln183">	RETURN(pf,f,get_next_format_from_precision(pf));</a>
<a name="ln184">	/*NOTREACHED*/</a>
<a name="ln185">}</a>
<a name="ln186"> </a>
<a name="ln187">static EFT</a>
<a name="ln188">get_next_format(const char **pf, EFT eft)</a>
<a name="ln189">{</a>
<a name="ln190">	int		infmt;</a>
<a name="ln191">	const char	*f;</a>
<a name="ln192"> </a>
<a name="ln193">	if (eft == FMTCHECK_WIDTH) {</a>
<a name="ln194">		(*pf)++;</a>
<a name="ln195">		return get_next_format_from_width(pf);</a>
<a name="ln196">	} else if (eft == FMTCHECK_PRECISION) {</a>
<a name="ln197">		(*pf)++;</a>
<a name="ln198">		return get_next_format_from_precision(pf);</a>
<a name="ln199">	}</a>
<a name="ln200"> </a>
<a name="ln201">	f = *pf;</a>
<a name="ln202">	infmt = 0;</a>
<a name="ln203">	while (!infmt) {</a>
<a name="ln204">		f = strchr(f, '%');</a>
<a name="ln205">		if (f == NULL)</a>
<a name="ln206">			RETURN(pf,f,FMTCHECK_DONE);</a>
<a name="ln207">		f++;</a>
<a name="ln208">		if (!*f)</a>
<a name="ln209">			RETURN(pf,f,FMTCHECK_UNKNOWN);</a>
<a name="ln210">		if (*f != '%')</a>
<a name="ln211">			infmt = 1;</a>
<a name="ln212">		else</a>
<a name="ln213">			f++;</a>
<a name="ln214">	}</a>
<a name="ln215"> </a>
<a name="ln216">	/* Eat any of the flags */</a>
<a name="ln217">	while (*f &amp;&amp; (strchr(&quot;#0- +&quot;, *f)))</a>
<a name="ln218">		f++;</a>
<a name="ln219"> </a>
<a name="ln220">	if (*f == '*') {</a>
<a name="ln221">		RETURN(pf,f,FMTCHECK_WIDTH);</a>
<a name="ln222">	}</a>
<a name="ln223">	/* eat any width */</a>
<a name="ln224">	while (isdigit((unsigned char)*f)) f++;</a>
<a name="ln225">	if (!*f) {</a>
<a name="ln226">		RETURN(pf,f,FMTCHECK_UNKNOWN);</a>
<a name="ln227">	}</a>
<a name="ln228"> </a>
<a name="ln229">	RETURN(pf,f,get_next_format_from_width(pf));</a>
<a name="ln230">	/*NOTREACHED*/</a>
<a name="ln231">}</a>
<a name="ln232"> </a>
<a name="ln233">const char *</a>
<a name="ln234">fmtcheck(const char *f1, const char *f2)</a>
<a name="ln235">{</a>
<a name="ln236">	const char	*f1p, *f2p;</a>
<a name="ln237">	EFT		f1t, f2t;</a>
<a name="ln238"> </a>
<a name="ln239">	if (!f1) return f2;</a>
<a name="ln240">	</a>
<a name="ln241">	f1p = f1;</a>
<a name="ln242">	f1t = FMTCHECK_START;</a>
<a name="ln243">	f2p = f2;</a>
<a name="ln244">	f2t = FMTCHECK_START;</a>
<a name="ln245">	while ((f1t = get_next_format(&amp;f1p, f1t)) != FMTCHECK_DONE) {</a>
<a name="ln246">		if (f1t == FMTCHECK_UNKNOWN)</a>
<a name="ln247">			return f2;</a>
<a name="ln248">		f2t = get_next_format(&amp;f2p, f2t);</a>
<a name="ln249">		if (f1t != f2t)</a>
<a name="ln250">			return f2;</a>
<a name="ln251">	}</a>
<a name="ln252">	return f1;</a>
<a name="ln253">}</a>
</code></pre>
<div class="balloon" rel="138"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v793/" target="_blank">V793</a> It is odd that the result of the 'sh + lg + quad + longdouble' statement is a part of the condition. Perhaps, this statement should have been compared with something else.</p></div>
<div class="balloon" rel="145"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v793/" target="_blank">V793</a> It is odd that the result of the 'sh + lg + quad' statement is a part of the condition. Perhaps, this statement should have been compared with something else.</p></div>
<div class="balloon" rel="150"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v793/" target="_blank">V793</a> It is odd that the result of the 'sh + lg + quad + longdouble' statement is a part of the condition. Perhaps, this statement should have been compared with something else.</p></div>
<div class="balloon" rel="155"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v793/" target="_blank">V793</a> It is odd that the result of the 'sh + lg + quad + longdouble' statement is a part of the condition. Perhaps, this statement should have been compared with something else.</p></div>
<div class="balloon" rel="160"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v793/" target="_blank">V793</a> It is odd that the result of the 'sh + lg + quad + longdouble' statement is a part of the condition. Perhaps, this statement should have been compared with something else.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>