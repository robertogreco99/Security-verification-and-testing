<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>print.c</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.5.1.min.js"></script>
</head>
<body>
<pre><code class = "cpp">
<a name="ln1">// This is a personal academic project. Dear PVS-Studio, please check it.</a>
<a name="ln2">// PVS-Studio Static Code Analyzer for C, C++, C#, and Java: http://www.viva64.com</a>
<a name="ln3">/*</a>
<a name="ln4"> * Copyright (c) Ian F. Darwin 1986-1995.</a>
<a name="ln5"> * Software written by Ian F. Darwin and others;</a>
<a name="ln6"> * maintained 1995-present by Christos Zoulas and others.</a>
<a name="ln7"> * </a>
<a name="ln8"> * Redistribution and use in source and binary forms, with or without</a>
<a name="ln9"> * modification, are permitted provided that the following conditions</a>
<a name="ln10"> * are met:</a>
<a name="ln11"> * 1. Redistributions of source code must retain the above copyright</a>
<a name="ln12"> *    notice immediately at the beginning of the file, without modification,</a>
<a name="ln13"> *    this list of conditions, and the following disclaimer.</a>
<a name="ln14"> * 2. Redistributions in binary form must reproduce the above copyright</a>
<a name="ln15"> *    notice, this list of conditions and the following disclaimer in the</a>
<a name="ln16"> *    documentation and/or other materials provided with the distribution.</a>
<a name="ln17"> *  </a>
<a name="ln18"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS'' AND</a>
<a name="ln19"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</a>
<a name="ln20"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</a>
<a name="ln21"> * ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE FOR</a>
<a name="ln22"> * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</a>
<a name="ln23"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</a>
<a name="ln24"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</a>
<a name="ln25"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</a>
<a name="ln26"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</a>
<a name="ln27"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</a>
<a name="ln28"> * SUCH DAMAGE.</a>
<a name="ln29"> */</a>
<a name="ln30">/*</a>
<a name="ln31"> * print.c - debugging printout routines</a>
<a name="ln32"> */</a>
<a name="ln33"> </a>
<a name="ln34">#include &quot;file.h&quot;</a>
<a name="ln35"> </a>
<a name="ln36">#ifndef lint</a>
<a name="ln37">FILE_RCSID(&quot;@(#)$File: print.c,v 1.81 2016/01/19 15:09:03 christos Exp $&quot;)</a>
<a name="ln38">#endif  /* lint */</a>
<a name="ln39"> </a>
<a name="ln40">#include &lt;string.h&gt;</a>
<a name="ln41">#include &lt;stdarg.h&gt;</a>
<a name="ln42">#include &lt;stdlib.h&gt;</a>
<a name="ln43">#ifdef HAVE_UNISTD_H</a>
<a name="ln44">#include &lt;unistd.h&gt;</a>
<a name="ln45">#endif</a>
<a name="ln46">#include &lt;time.h&gt;</a>
<a name="ln47"> </a>
<a name="ln48">#define SZOF(a)	(sizeof(a) / sizeof(a[0]))</a>
<a name="ln49"> </a>
<a name="ln50">#include &quot;cdf.h&quot;</a>
<a name="ln51"> </a>
<a name="ln52">#ifndef COMPILE_ONLY</a>
<a name="ln53">protected void</a>
<a name="ln54">file_mdump(struct magic *m)</a>
<a name="ln55">{</a>
<a name="ln56">	static const char optyp[] = { FILE_OPS };</a>
<a name="ln57">	char tbuf[26];</a>
<a name="ln58"> </a>
<a name="ln59">	(void) fprintf(stderr, &quot;%u: %.*s %u&quot;, m-&gt;lineno,</a>
<a name="ln60">	    (m-&gt;cont_level &amp; 7) + 1, &quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;, m-&gt;offset);</a>
<a name="ln61"> </a>
<a name="ln62">	if (m-&gt;flag &amp; INDIR) {</a>
<a name="ln63">		(void) fprintf(stderr, &quot;(%s,&quot;,</a>
<a name="ln64">		    /* Note: type is unsigned */</a>
<a name="ln65">		    (m-&gt;in_type &lt; file_nnames) ? file_names[m-&gt;in_type] :</a>
<a name="ln66">		    &quot;*bad in_type*&quot;);</a>
<a name="ln67">		if (m-&gt;in_op &amp; FILE_OPINVERSE)</a>
<a name="ln68">			(void) fputc('~', stderr);</a>
<a name="ln69">		(void) fprintf(stderr, &quot;%c%u),&quot;,</a>
<a name="ln70">		    ((size_t)(m-&gt;in_op &amp; FILE_OPS_MASK) &lt;</a>
<a name="ln71">		    SZOF(optyp)) ? optyp[m-&gt;in_op &amp; FILE_OPS_MASK] : '?',</a>
<a name="ln72">		    m-&gt;in_offset);</a>
<a name="ln73">	}</a>
<a name="ln74">	(void) fprintf(stderr, &quot; %s%s&quot;, (m-&gt;flag &amp; UNSIGNED) ? &quot;u&quot; : &quot;&quot;,</a>
<a name="ln75">	    /* Note: type is unsigned */</a>
<a name="ln76">	    (m-&gt;type &lt; file_nnames) ? file_names[m-&gt;type] : &quot;*bad type&quot;);</a>
<a name="ln77">	if (m-&gt;mask_op &amp; FILE_OPINVERSE)</a>
<a name="ln78">		(void) fputc('~', stderr);</a>
<a name="ln79"> </a>
<a name="ln80">	if (IS_STRING(m-&gt;type)) {</a>
<a name="ln81">		if (m-&gt;str_flags) {</a>
<a name="ln82">			(void) fputc('/', stderr);</a>
<a name="ln83">			if (m-&gt;str_flags &amp; STRING_COMPACT_WHITESPACE) </a>
<a name="ln84">				(void) fputc(CHAR_COMPACT_WHITESPACE, stderr);</a>
<a name="ln85">			if (m-&gt;str_flags &amp; STRING_COMPACT_OPTIONAL_WHITESPACE) </a>
<a name="ln86">				(void) fputc(CHAR_COMPACT_OPTIONAL_WHITESPACE,</a>
<a name="ln87">				    stderr);</a>
<a name="ln88">			if (m-&gt;str_flags &amp; STRING_IGNORE_LOWERCASE) </a>
<a name="ln89">				(void) fputc(CHAR_IGNORE_LOWERCASE, stderr);</a>
<a name="ln90">			if (m-&gt;str_flags &amp; STRING_IGNORE_UPPERCASE) </a>
<a name="ln91">				(void) fputc(CHAR_IGNORE_UPPERCASE, stderr);</a>
<a name="ln92">			if (m-&gt;str_flags &amp; REGEX_OFFSET_START) </a>
<a name="ln93">				(void) fputc(CHAR_REGEX_OFFSET_START, stderr);</a>
<a name="ln94">			if (m-&gt;str_flags &amp; STRING_TEXTTEST)</a>
<a name="ln95">				(void) fputc(CHAR_TEXTTEST, stderr);</a>
<a name="ln96">			if (m-&gt;str_flags &amp; STRING_BINTEST)</a>
<a name="ln97">				(void) fputc(CHAR_BINTEST, stderr);</a>
<a name="ln98">			if (m-&gt;str_flags &amp; PSTRING_1_BE)</a>
<a name="ln99">				(void) fputc(CHAR_PSTRING_1_BE, stderr);</a>
<a name="ln100">			if (m-&gt;str_flags &amp; PSTRING_2_BE)</a>
<a name="ln101">				(void) fputc(CHAR_PSTRING_2_BE, stderr);</a>
<a name="ln102">			if (m-&gt;str_flags &amp; PSTRING_2_LE)</a>
<a name="ln103">				(void) fputc(CHAR_PSTRING_2_LE, stderr);</a>
<a name="ln104">			if (m-&gt;str_flags &amp; PSTRING_4_BE)</a>
<a name="ln105">				(void) fputc(CHAR_PSTRING_4_BE, stderr);</a>
<a name="ln106">			if (m-&gt;str_flags &amp; PSTRING_4_LE)</a>
<a name="ln107">				(void) fputc(CHAR_PSTRING_4_LE, stderr);</a>
<a name="ln108">			if (m-&gt;str_flags &amp; PSTRING_LENGTH_INCLUDES_ITSELF)</a>
<a name="ln109">				(void) fputc(</a>
<a name="ln110">				    CHAR_PSTRING_LENGTH_INCLUDES_ITSELF,</a>
<a name="ln111">				    stderr);</a>
<a name="ln112">		}</a>
<a name="ln113">		if (m-&gt;str_range)</a>
<a name="ln114">			(void) fprintf(stderr, &quot;/%u&quot;, m-&gt;str_range);</a>
<a name="ln115">	}</a>
<a name="ln116">	else {</a>
<a name="ln117">		if ((size_t)(m-&gt;mask_op &amp; FILE_OPS_MASK) &lt; SZOF(optyp))</a>
<a name="ln118">			(void) fputc(optyp[m-&gt;mask_op &amp; FILE_OPS_MASK], stderr);</a>
<a name="ln119">		else</a>
<a name="ln120">			(void) fputc('?', stderr);</a>
<a name="ln121">			</a>
<a name="ln122">		if (m-&gt;num_mask) {</a>
<a name="ln123">			(void) fprintf(stderr, &quot;%.8llx&quot;,</a>
<a name="ln124">			    (unsigned long long)m-&gt;num_mask);</a>
<a name="ln125">		}</a>
<a name="ln126">	}</a>
<a name="ln127">	(void) fprintf(stderr, &quot;,%c&quot;, m-&gt;reln);</a>
<a name="ln128"> </a>
<a name="ln129">	if (m-&gt;reln != 'x') {</a>
<a name="ln130">		switch (m-&gt;type) {</a>
<a name="ln131">		case FILE_BYTE:</a>
<a name="ln132">		case FILE_SHORT:</a>
<a name="ln133">		case FILE_LONG:</a>
<a name="ln134">		case FILE_LESHORT:</a>
<a name="ln135">		case FILE_LELONG:</a>
<a name="ln136">		case FILE_MELONG:</a>
<a name="ln137">		case FILE_BESHORT:</a>
<a name="ln138">		case FILE_BELONG:</a>
<a name="ln139">		case FILE_INDIRECT:</a>
<a name="ln140">			(void) fprintf(stderr, &quot;%d&quot;, m-&gt;value.l);</a>
<a name="ln141">			break;</a>
<a name="ln142">		case FILE_BEQUAD:</a>
<a name="ln143">		case FILE_LEQUAD:</a>
<a name="ln144">		case FILE_QUAD:</a>
<a name="ln145">			(void) fprintf(stderr, &quot;%&quot; INT64_T_FORMAT &quot;d&quot;,</a>
<a name="ln146">			    (unsigned long long)m-&gt;value.q);</a>
<a name="ln147">			break;</a>
<a name="ln148">		case FILE_PSTRING:</a>
<a name="ln149">		case FILE_STRING:</a>
<a name="ln150">		case FILE_REGEX:</a>
<a name="ln151">		case FILE_BESTRING16:</a>
<a name="ln152">		case FILE_LESTRING16:</a>
<a name="ln153">		case FILE_SEARCH:</a>
<a name="ln154">			file_showstr(stderr, m-&gt;value.s, (size_t)m-&gt;vallen);</a>
<a name="ln155">			break;</a>
<a name="ln156">		case FILE_DATE:</a>
<a name="ln157">		case FILE_LEDATE:</a>
<a name="ln158">		case FILE_BEDATE:</a>
<a name="ln159">		case FILE_MEDATE:</a>
<a name="ln160">			(void)fprintf(stderr, &quot;%s,&quot;,</a>
<a name="ln161">			    file_fmttime(m-&gt;value.l, 0, tbuf));</a>
<a name="ln162">			break;</a>
<a name="ln163">		case FILE_LDATE:</a>
<a name="ln164">		case FILE_LELDATE:</a>
<a name="ln165">		case FILE_BELDATE:</a>
<a name="ln166">		case FILE_MELDATE:</a>
<a name="ln167">			(void)fprintf(stderr, &quot;%s,&quot;,</a>
<a name="ln168">			    file_fmttime(m-&gt;value.l, FILE_T_LOCAL, tbuf));</a>
<a name="ln169">			break;</a>
<a name="ln170">		case FILE_QDATE:</a>
<a name="ln171">		case FILE_LEQDATE:</a>
<a name="ln172">		case FILE_BEQDATE:</a>
<a name="ln173">			(void)fprintf(stderr, &quot;%s,&quot;,</a>
<a name="ln174">			    file_fmttime(m-&gt;value.q, 0, tbuf));</a>
<a name="ln175">			break;</a>
<a name="ln176">		case FILE_QLDATE:</a>
<a name="ln177">		case FILE_LEQLDATE:</a>
<a name="ln178">		case FILE_BEQLDATE:</a>
<a name="ln179">			(void)fprintf(stderr, &quot;%s,&quot;,</a>
<a name="ln180">			    file_fmttime(m-&gt;value.q, FILE_T_LOCAL, tbuf));</a>
<a name="ln181">			break;</a>
<a name="ln182">		case FILE_QWDATE:</a>
<a name="ln183">		case FILE_LEQWDATE:</a>
<a name="ln184">		case FILE_BEQWDATE:</a>
<a name="ln185">			(void)fprintf(stderr, &quot;%s,&quot;,</a>
<a name="ln186">			    file_fmttime(m-&gt;value.q, FILE_T_WINDOWS, tbuf));</a>
<a name="ln187">			break;</a>
<a name="ln188">		case FILE_FLOAT:</a>
<a name="ln189">		case FILE_BEFLOAT:</a>
<a name="ln190">		case FILE_LEFLOAT:</a>
<a name="ln191">			(void) fprintf(stderr, &quot;%G&quot;, m-&gt;value.f);</a>
<a name="ln192">			break;</a>
<a name="ln193">		case FILE_DOUBLE:</a>
<a name="ln194">		case FILE_BEDOUBLE:</a>
<a name="ln195">		case FILE_LEDOUBLE:</a>
<a name="ln196">			(void) fprintf(stderr, &quot;%G&quot;, m-&gt;value.d);</a>
<a name="ln197">			break;</a>
<a name="ln198">		case FILE_DEFAULT:</a>
<a name="ln199">			/* XXX - do anything here? */</a>
<a name="ln200">			break;</a>
<a name="ln201">		case FILE_USE:</a>
<a name="ln202">		case FILE_NAME:</a>
<a name="ln203">		case FILE_DER:</a>
<a name="ln204">			(void) fprintf(stderr, &quot;'%s'&quot;, m-&gt;value.s);</a>
<a name="ln205">			break;</a>
<a name="ln206">		default:</a>
<a name="ln207">			(void) fprintf(stderr, &quot;*bad type %d*&quot;, m-&gt;type);</a>
<a name="ln208">			break;</a>
<a name="ln209">		}</a>
<a name="ln210">	}</a>
<a name="ln211">	(void) fprintf(stderr, &quot;,\&quot;%s\&quot;]\n&quot;, m-&gt;desc);</a>
<a name="ln212">}</a>
<a name="ln213">#endif</a>
<a name="ln214"> </a>
<a name="ln215">/*VARARGS*/</a>
<a name="ln216">protected void</a>
<a name="ln217">file_magwarn(struct magic_set *ms, const char *f, ...)</a>
<a name="ln218">{</a>
<a name="ln219">	va_list va;</a>
<a name="ln220"> </a>
<a name="ln221">	/* cuz we use stdout for most, stderr here */</a>
<a name="ln222">	(void) fflush(stdout); </a>
<a name="ln223"> </a>
<a name="ln224">	if (ms-&gt;file)</a>
<a name="ln225">		(void) fprintf(stderr, &quot;%s, %lu: &quot;, ms-&gt;file,</a>
<a name="ln226">		    (unsigned long)ms-&gt;line);</a>
<a name="ln227">	(void) fprintf(stderr, &quot;Warning: &quot;);</a>
<a name="ln228">	va_start(va, f);</a>
<a name="ln229">	(void) vfprintf(stderr, f, va);</a>
<a name="ln230">	va_end(va);</a>
<a name="ln231">	(void) fputc('\n', stderr);</a>
<a name="ln232">}</a>
<a name="ln233"> </a>
<a name="ln234">protected const char *</a>
<a name="ln235">file_fmttime(uint64_t v, int flags, char *buf)</a>
<a name="ln236">{</a>
<a name="ln237">	char *pp;</a>
<a name="ln238">	time_t t;</a>
<a name="ln239">	struct tm *tm, tmz;</a>
<a name="ln240"> </a>
<a name="ln241">	if (flags &amp; FILE_T_WINDOWS) {</a>
<a name="ln242">		struct timespec ts;</a>
<a name="ln243">		cdf_timestamp_to_timespec(&amp;ts, CAST(cdf_timestamp_t, v));</a>
<a name="ln244">		t = ts.tv_sec;</a>
<a name="ln245">	} else {</a>
<a name="ln246">		// XXX: perhaps detect and print something if overflow</a>
<a name="ln247">		// on 32 bit time_t?</a>
<a name="ln248">		t = (time_t)v;</a>
<a name="ln249">	}</a>
<a name="ln250"> </a>
<a name="ln251">	if (flags &amp; FILE_T_LOCAL) {</a>
<a name="ln252">		tm = localtime_r(&amp;t, &amp;tmz);</a>
<a name="ln253">	} else {</a>
<a name="ln254">		tm = gmtime_r(&amp;t, &amp;tmz);</a>
<a name="ln255">	}</a>
<a name="ln256">	if (tm == NULL)</a>
<a name="ln257">		goto out;</a>
<a name="ln258">	pp = asctime_r(tm, buf);</a>
<a name="ln259"> </a>
<a name="ln260">	if (pp == NULL)</a>
<a name="ln261">		goto out;</a>
<a name="ln262">	pp[strcspn(pp, &quot;\n&quot;)] = '\0';</a>
<a name="ln263">	return pp;</a>
<a name="ln264">out:</a>
<a name="ln265">	return strcpy(buf, &quot;*Invalid time*&quot;);</a>
<a name="ln266">}</a>
</code></pre>
<div class="balloon" rel="70"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v547/" target="_blank">V547</a> Expression is always true.</p></div>
<div class="balloon" rel="117"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v547/" target="_blank">V547</a> Expression is always true.</p></div>
<div class="balloon" rel="69"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v576/" target="_blank">V576</a> Incorrect format. Consider checking the fourth actual argument of the 'fprintf' function. The UNSIGNED integer type argument is expected.</p></div>
<div class="balloon" rel="140"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v576/" target="_blank">V576</a> Incorrect format. Consider checking the third actual argument of the 'fprintf' function. The SIGNED integer type argument is expected.</p></div>
<div class="balloon" rel="145"><p><span style="font-size:18px">&uarr;</span> <a href="https://pvs-studio.com/en/docs/warnings/v576/" target="_blank">V576</a> Incorrect format. Consider checking the third actual argument of the 'fprintf' function. The SIGNED integer type argument is expected.</p></div>
<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>